pipeline{
    agent any

    stages {
        stage('Run Dagger function tofu-init') {
            steps {
                withCredentials([
                    string(credentialsId: 'infracost-api-key', variable: 'INFRACOST_API_KEY'),
                    string(credentialsId: 'ssh-private-key', variable: 'SSH_PRIVATE_KEY'),
                    string(credentialsId: 'ssh-public-key', variable: 'SSH_PUBLIC_KEY'),
                    file(credentialsId: 'gcp-api-key', variable: 'GCP_KEY_FILE')
                ]){
                    sh '''
                    cd "$WORKSPACE/iac-pipeline"
                    pwd
                    export GCP_CREDENTIALS=\$(cat "\$GCP_KEY_FILE")

                    dagger call tofu-init \\
                    --src=../iac/gcloud \\
                    --budget-eur=40 \\
                    --infracost-api-key=env:INFRACOST_API_KEY \\
                    --ssh-private-key=env:SSH_PRIVATE_KEY \\
                    --ssh-public-key=env:SSH_PUBLIC_KEY \\
                    --gcp_sa_key=env:GCP_CREDENTIALS \\
                    --output $WORKSPACE/tofu-inits
                    '''
                }
            }
        }
        stage('Run Dagger function tofu-apply-cheapest'){
            steps{
                withCredentials([
                    string(credentialsId: 'ssh-private-key', variable: 'SSH_PRIVATE_KEY'),
                    string(credentialsId: 'ssh-public-key', variable: 'SSH_PUBLIC_KEY'),
                    file(credentialsId: 'gcp-api-key', variable: 'GCP_KEY_FILE')
                ]){
                    sh '''
                    cd "$WORKSPACE/iac-pipeline"
                    pwd
                    export GCP_CREDENTIALS=\$(cat "\$GCP_KEY_FILE")

                    dagger call tofu-apply-cheapest \\
                    --src=../iac/gcloud \\
                    --costs-json=../tofu-inits/costs.json \\
                    --gcp_sa_key=env:GCP_CREDENTIALS \\
                    --ssh-private-key=env:SSH_PRIVATE_KEY \\
                    --ssh-public-key=env:SSH_PUBLIC_KEY \\
                    --deployment-id="$(date +%s)" \\
                    --output ../deployment
                '''
                }
            }
        }
    }
}